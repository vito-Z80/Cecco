[gd_scene load_steps=29 format=2]

[ext_resource path="res://Atlas/a.png" type="Texture" id=1]
[ext_resource path="res://Scenes/Bullet.tscn" type="PackedScene" id=2]
[ext_resource path="res://Atlas/gun_barrel.tres" type="Texture" id=3]

[sub_resource type="GDScript" id=1]
script/source = "extends StaticBody2D


onready var gun = $Gun
onready var burrel = $Burrel
var look_right = 32
var look_left = -16

var left_limit:int
var right_limit:int

var is_destroy = false

var bullets = Array()


func _ready():
	# for clamp position? or visiblity  notifier
	left_limit = position.x - 200
	right_limit = position.x + 200

func _physics_process(delta):
	var hero_position = get_viewport().get_mouse_position()
#	var hero_position = g.hero_position
	
	burrel.flip_h = hero_position.x > position.x + 16
	gun.flip_h = burrel.flip_h

	if burrel.flip_h:
		burrel.position.x = look_right
	else:
		burrel.position.x = look_left
		
"

[sub_resource type="AtlasTexture" id=2]
atlas = ExtResource( 1 )
region = Rect2( 332, 268, 32, 40 )

[sub_resource type="RectangleShape2D" id=3]
extents = Vector2( 16, 19.8373 )

[sub_resource type="AtlasTexture" id=4]
atlas = ExtResource( 3 )
region = Rect2( 300, 396, 16, 8 )

[sub_resource type="AtlasTexture" id=5]
atlas = ExtResource( 3 )
region = Rect2( 300, 404, 16, 8 )

[sub_resource type="AtlasTexture" id=6]
atlas = ExtResource( 3 )
region = Rect2( 300, 412, 16, 8 )

[sub_resource type="AtlasTexture" id=7]
atlas = ExtResource( 3 )
region = Rect2( 300, 420, 16, 8 )

[sub_resource type="AtlasTexture" id=8]
atlas = ExtResource( 3 )
region = Rect2( 300, 428, 16, 8 )

[sub_resource type="AtlasTexture" id=9]
atlas = ExtResource( 3 )
region = Rect2( 300, 436, 16, 8 )

[sub_resource type="AtlasTexture" id=10]
atlas = ExtResource( 3 )
region = Rect2( 300, 444, 16, 8 )

[sub_resource type="AtlasTexture" id=11]
atlas = ExtResource( 3 )
region = Rect2( 300, 452, 16, 8 )

[sub_resource type="AtlasTexture" id=12]
atlas = ExtResource( 3 )
region = Rect2( 300, 452, 16, 8 )

[sub_resource type="AtlasTexture" id=13]
atlas = ExtResource( 3 )
region = Rect2( 300, 444, 16, 8 )

[sub_resource type="AtlasTexture" id=14]
atlas = ExtResource( 3 )
region = Rect2( 300, 444, 16, 8 )

[sub_resource type="AtlasTexture" id=15]
atlas = ExtResource( 3 )
region = Rect2( 300, 436, 16, 8 )

[sub_resource type="AtlasTexture" id=16]
atlas = ExtResource( 3 )
region = Rect2( 300, 436, 16, 8 )

[sub_resource type="AtlasTexture" id=17]
atlas = ExtResource( 3 )
region = Rect2( 300, 428, 16, 8 )

[sub_resource type="AtlasTexture" id=18]
atlas = ExtResource( 3 )
region = Rect2( 300, 428, 16, 8 )

[sub_resource type="AtlasTexture" id=19]
atlas = ExtResource( 3 )
region = Rect2( 300, 420, 16, 8 )

[sub_resource type="AtlasTexture" id=20]
atlas = ExtResource( 3 )
region = Rect2( 300, 412, 16, 8 )

[sub_resource type="AtlasTexture" id=21]
atlas = ExtResource( 3 )
region = Rect2( 300, 420, 16, 8 )

[sub_resource type="AtlasTexture" id=22]
atlas = ExtResource( 3 )
region = Rect2( 300, 396, 16, 8 )

[sub_resource type="AtlasTexture" id=23]
atlas = ExtResource( 3 )
region = Rect2( 300, 396, 16, 8 )

[sub_resource type="SpriteFrames" id=24]
animations = [ {
"frames": [ SubResource( 4 ), SubResource( 5 ), SubResource( 6 ), SubResource( 7 ), SubResource( 8 ), SubResource( 9 ), SubResource( 10 ), SubResource( 11 ), SubResource( 12 ), SubResource( 13 ), SubResource( 14 ), SubResource( 15 ), SubResource( 16 ), SubResource( 17 ), SubResource( 18 ), SubResource( 19 ), SubResource( 20 ), SubResource( 21 ), SubResource( 22 ), SubResource( 23 ) ],
"loop": true,
"name": "default",
"speed": 60.0
} ]

[sub_resource type="GDScript" id=25]
script/source = "extends AnimatedSprite

export (PackedScene) var Bullet
var bullets = Array()


func _ready():
	
	for i in 3:
		create_bullet()
	
	
func _physics_process(delta):
	shot()
	if playing && frame == 19:
		frame = 0	
		playing = false
	for b in bullets:
		if b.visible:
			b.position.x -= 2


func shot():
	# TODO: передеать. пушка продолжает стрелять если уйти двальше нее
	# - неверное сравнение.
	if randf() > 0.016: return
	var dist = distance_to_object(get_parent().position.x) 
	if dist > 160: return
		
	for b in bullets:
		if !b.visible:
			b.visible = true
			playing = true
			Sound.big_gun_fire()
			print(dist)
			return
			
	for b in bullets:		
		if b.visible && b.position.x < g.hero_position.x:
			b.visible = false
			frame = 0
			playing = false

func distance_to_object(x:int):
	x = clamp(x - g.hero_position.x,0,255)
	return abs(x)

func create_bullet():
	var s = Bullet.instance()
	s.visible = false
	add_child(s)
	bullets.append(s)
"

[node name="BigGun" type="StaticBody2D"]
script = SubResource( 1 )
__meta__ = {
"_edit_group_": true
}

[node name="Gun" type="Sprite" parent="."]
texture = SubResource( 2 )
centered = false

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2( 16, 20 )
shape = SubResource( 3 )

[node name="Burrel" type="AnimatedSprite" parent="."]
position = Vector2( -16, 8 )
frames = SubResource( 24 )
centered = false
script = SubResource( 25 )
Bullet = ExtResource( 2 )
