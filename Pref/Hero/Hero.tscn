[gd_scene load_steps=30 format=2]

[ext_resource path="res://Pref/Hero/BulletMove.tscn" type="PackedScene" id=1]
[ext_resource path="res://Atlas/hero_regions.tres" type="Texture" id=2]

[sub_resource type="GDScript" id=1]
script/source = "extends KinematicBody2D

signal jump


export (PackedScene) var bullet

const SIT = \"sit\"
const SIT_PERFECT = \"sit_perfect\"
const WALK = \"walk\"
const WALK_PERFECT = \"walk_perfect\"
const DEAD = \"dead\"
const DEAD_PERFECT = \"dead_perfect\"
onready var anim = $AnimatedSprite

var is_damage = false
var speed = 60
var velocity = Vector2()



var hero_type = TYPE.NORMAL
enum TYPE{
	NORMAL,
	PERFECT
}
var state = STATE.STAY
enum STATE{
	SIT,WALK,JUMP,DEAD,STAY
}




	


func dead(delta):
	if anim.animation == \"dead_perfect\" && velocity.y == 0:
		return
	anim.play(\"dead_perfect\")
	if is_on_floor():
		velocity.x = 0
		velocity.y -= 98
	fall(delta)
	move_and_slide(velocity,Vector2.UP)
	
func fall(delta):
	velocity.y += delta * speed * 4.4
#	pass
	
func move(delta):
	
	if is_on_floor():
		if Input.is_action_just_pressed(\"jump\"):
			g.jump = true
			velocity.y -= 108
		else:
			velocity.y =0 

		
	if !is_damage:
		if Input.is_action_pressed(\"walk_left\"):
			anim.flip_h = true
			velocity.x = -speed
		elif Input.is_action_pressed(\"walk_right\"):
			anim.flip_h = false
			velocity.x = speed
		else:
			velocity.x = 0
	else:
		velocity.x = 0
		
	
	match hero_type:
		TYPE.NORMAL:
			anim.animation = WALK
		TYPE.IMPROVED:
			anim.animation = WALK_PERFECT

	anim.playing = velocity.x != 0

	fall(delta)
	move_and_slide(velocity,Vector2.UP)
		
func _physics_process(delta):
	
	is_damage = false
	
	g.hero_position = $Camera2D.get_camera_position()
	g.jump = false
	if is_damage:
		dead(delta)
	else:
		fire(delta)
		if !sit():
			move(delta)
	velocity.x = int(velocity.x)
	velocity.y = int(velocity.y)
	
	
#-------------------SIT-------------------------------
func sit():
	if !is_on_floor(): return false
	if Input.is_action_pressed(\"sit\"):
		$CollisionShape2D.position.y = 22
		anim.play(\"sit\")
		return true
	else:
		$CollisionShape2D.position.y = 17
		return false


#-------------------FIRE-----------------------------
var grenade_timer = 0
var bullet_direction = 0
func fire(delta):
	if Input.is_action_pressed(\"fire\"):
		grenade_timer += delta
	else:
		grenade_timer = 0
	
	if grenade_timer >= 0.5:
		get_node(\"../HeroGrenade\").emit_signal(\"fire\",position, anim.flip_h)
		Sound.grenade_launch()
#		$HeroGrenade.emit_signal(\"fire\",position)
	
	if Input.is_action_just_pressed(\"fire\"):
		bullet_direction = -1 if $AnimatedSprite.flip_h else 1
		show_bullet(bullet, position, bullet_direction)
		Sound.fire()
#------------------------Bullets POOL---------------------------------
var pool = Array()
func show_bullet(bullet_node, bullet_position, direction):
	if pool.empty():
		return create_new_bullet(bullet_node, bullet_position, direction)
	else:
		return find_free(bullet_node, bullet_position, direction)

func find_free(bullet_node, bullet_position, direction):
	var count = pool.size()
	for b in pool:
		if !b.visible:
			b.visible = true
			b.direction = direction
			b.position = bullet_position
			
			b.position.y += 13
			
			if direction > 0:
				b.position.x += 24
			else:
				b.position.x -= 8
			b.launch_position_x = b.position.x
			return
		else:
			count -= 1
	if count == 0:
		create_new_bullet(bullet_node, bullet_position, direction)

func create_new_bullet(bullet_node, bullet_position, direction):
	var b = bullet_node.instance()
	b.direction = direction
	b.position = bullet_position
	b.position.y += 13
	b.speed = 3
	if direction > 0:
		b.position.x += 24
	else:
		b.position.x -= 8
	b.launch_position_x = b.position.x
		
	get_parent().add_child(b)
	pool.append(b)

func set_bullet_y():
	
	pass

#--------------------------------------------------------------------
"

[sub_resource type="RectangleShape2D" id=2]
extents = Vector2( 10, 15 )

[sub_resource type="AtlasTexture" id=3]
atlas = ExtResource( 2 )
region = Rect2( 252, 596, 24, 32 )

[sub_resource type="AtlasTexture" id=4]
atlas = ExtResource( 2 )
region = Rect2( 156, 500, 24, 32 )

[sub_resource type="AtlasTexture" id=5]
atlas = ExtResource( 2 )
region = Rect2( 180, 500, 24, 32 )

[sub_resource type="AtlasTexture" id=6]
atlas = ExtResource( 2 )
region = Rect2( 204, 500, 24, 32 )

[sub_resource type="AtlasTexture" id=7]
atlas = ExtResource( 2 )
region = Rect2( 228, 500, 24, 32 )

[sub_resource type="AtlasTexture" id=8]
atlas = ExtResource( 2 )
region = Rect2( 252, 500, 24, 32 )

[sub_resource type="AtlasTexture" id=9]
atlas = ExtResource( 2 )
region = Rect2( 276, 500, 24, 32 )

[sub_resource type="AtlasTexture" id=10]
atlas = ExtResource( 2 )
region = Rect2( 156, 532, 24, 32 )

[sub_resource type="AtlasTexture" id=11]
atlas = ExtResource( 2 )
region = Rect2( 180, 532, 24, 32 )

[sub_resource type="AtlasTexture" id=12]
atlas = ExtResource( 2 )
region = Rect2( 204, 532, 24, 32 )

[sub_resource type="AtlasTexture" id=13]
atlas = ExtResource( 2 )
region = Rect2( 228, 532, 24, 32 )

[sub_resource type="AtlasTexture" id=14]
atlas = ExtResource( 2 )
region = Rect2( 156, 564, 24, 32 )

[sub_resource type="AtlasTexture" id=15]
atlas = ExtResource( 2 )
region = Rect2( 180, 564, 24, 32 )

[sub_resource type="AtlasTexture" id=16]
atlas = ExtResource( 2 )
region = Rect2( 204, 564, 24, 32 )

[sub_resource type="AtlasTexture" id=17]
atlas = ExtResource( 2 )
region = Rect2( 228, 564, 24, 32 )

[sub_resource type="AtlasTexture" id=18]
atlas = ExtResource( 2 )
region = Rect2( 252, 564, 24, 32 )

[sub_resource type="AtlasTexture" id=19]
atlas = ExtResource( 2 )
region = Rect2( 276, 564, 24, 32 )

[sub_resource type="AtlasTexture" id=20]
atlas = ExtResource( 2 )
region = Rect2( 156, 596, 24, 32 )

[sub_resource type="AtlasTexture" id=21]
atlas = ExtResource( 2 )
region = Rect2( 180, 596, 24, 32 )

[sub_resource type="AtlasTexture" id=22]
atlas = ExtResource( 2 )
region = Rect2( 204, 596, 24, 32 )

[sub_resource type="AtlasTexture" id=23]
atlas = ExtResource( 2 )
region = Rect2( 228, 596, 24, 32 )

[sub_resource type="AtlasTexture" id=24]
atlas = ExtResource( 2 )
region = Rect2( 276, 596, 24, 32 )

[sub_resource type="AtlasTexture" id=25]
atlas = ExtResource( 2 )
region = Rect2( 276, 532, 24, 32 )

[sub_resource type="AtlasTexture" id=26]
atlas = ExtResource( 2 )
region = Rect2( 252, 532, 24, 32 )

[sub_resource type="SpriteFrames" id=27]
animations = [ {
"frames": [ SubResource( 3 ) ],
"loop": true,
"name": "sit_perfect",
"speed": 5.0
}, {
"frames": [ SubResource( 4 ), SubResource( 5 ), SubResource( 6 ), SubResource( 7 ), SubResource( 8 ), SubResource( 9 ), SubResource( 10 ), SubResource( 11 ), SubResource( 12 ), SubResource( 13 ) ],
"loop": true,
"name": "walk",
"speed": 12.5
}, {
"frames": [ SubResource( 14 ), SubResource( 15 ), SubResource( 16 ), SubResource( 17 ), SubResource( 18 ), SubResource( 19 ), SubResource( 20 ), SubResource( 21 ), SubResource( 22 ), SubResource( 23 ) ],
"loop": true,
"name": "walk_perfect",
"speed": 12.5
}, {
"frames": [ SubResource( 24 ) ],
"loop": true,
"name": "dead_perfect",
"speed": 5.0
}, {
"frames": [ SubResource( 25 ) ],
"loop": true,
"name": "dead",
"speed": 5.0
}, {
"frames": [ SubResource( 26 ) ],
"loop": true,
"name": "sit",
"speed": 25.0
} ]

[node name="Hero" type="KinematicBody2D"]
script = SubResource( 1 )
bullet = ExtResource( 1 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2( 12, 17 )
shape = SubResource( 2 )

[node name="AnimatedSprite" type="AnimatedSprite" parent="."]
frames = SubResource( 27 )
animation = "walk"
centered = false

[node name="Camera2D" type="Camera2D" parent="."]
offset = Vector2( 12, 0 )
current = true
limit_left = -12
limit_top = 0
limit_right = 6384
limit_bottom = 0
smoothing_enabled = true
smoothing_speed = 8.0
